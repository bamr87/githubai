name: AI Issue Processing

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  process-issue:
    if: contains(github.event.issue.labels.*.name, 'ai-assist') || contains(github.event.issue.labels.*.name, 'README-update')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create environment file
        run: |
          echo "DEBUG=True" > .env
          echo "SECRET_KEY=github-actions-key" >> .env
          echo "DATABASE_URL=sqlite:///db.sqlite3" >> .env
          echo "AI_API_KEY=${{ secrets.AI_API_KEY }}" >> .env
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -f infra/docker/Dockerfile -t githubai:latest .

      - name: Run Django migrations
        run: |
          docker run --rm -v "$PWD":/app --env-file .env githubai:latest python manage.py migrate --run-syncdb

      - name: Process AI Assist Issue
        if: contains(github.event.issue.labels.*.name, 'ai-assist')
        run: |
          docker run --rm -v "$PWD":/app --env-file .env githubai:latest python manage.py create_issue \
            --repo "${{ github.repository }}" \
            --parent "${{ github.event.issue.number }}"

      - name: Process README Update Issue
        if: contains(github.event.issue.labels.*.name, 'README-update')
        run: |
          docker run --rm -v "$PWD":/app --env-file .env githubai:latest python manage.py create_issue \
            --repo "${{ github.repository }}" \
            --readme-update \
            --issue-number "${{ github.event.issue.number }}"

      - name: Display Logs
        if: always()
        run: |
          if [ -f logs/django.log ]; then
            echo "## Django Logs:"
            tail -50 logs/django.log
          fi
          if [ -f logs/ai_api.log ]; then
            echo "## AI API Logs:"
            cat logs/ai_api.log
          fi
