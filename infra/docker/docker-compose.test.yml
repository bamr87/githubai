# Docker Compose override for TEST environment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.test.yml up -d
# This creates an isolated test environment with separate database, ports, and volumes

services:
  db:
    container_name: githubai_db_test
    environment:
      POSTGRES_DB: githubai_test
      POSTGRES_USER: githubai_test
      POSTGRES_PASSWORD: test123
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # Different port to avoid conflicts

  redis:
    container_name: githubai_redis_test
    volumes:
      - redis_test_data:/data
    ports:
      - "6380:6379"  # Different port to avoid conflicts

  web:
    container_name: githubai_web_test
    environment:
      - DJANGO_SETTINGS_MODULE=githubai.settings_test
      - TEST_ENV=true
      - DATABASE_URL=postgresql://githubai_test:test123@db:5432/githubai_test
      - CELERY_BROKER_URL=redis://redis:6379/1  # Use different Redis DB
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    env_file:
      - ../../.env.test
    ports:
      - "8001:8000"  # Different port to avoid conflicts
    volumes:
      - ../../apps:/app/apps:rw
      - ../../tests:/app/tests:rw
      - ../../docs:/app/docs:rw
      - static_test_volume:/app/staticfiles
      - media_test_volume:/app/media
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  celery_worker:
    container_name: githubai_celery_worker_test
    environment:
      - DJANGO_SETTINGS_MODULE=githubai.settings_test
      - TEST_ENV=true
      - DATABASE_URL=postgresql://githubai_test:test123@db:5432/githubai_test
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    env_file:
      - ../../.env.test
    volumes:
      - ../../apps:/app/apps:rw
      - ../../tests:/app/tests:rw
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  celery_beat:
    container_name: githubai_celery_beat_test
    environment:
      - DJANGO_SETTINGS_MODULE=githubai.settings_test
      - TEST_ENV=true
      - DATABASE_URL=postgresql://githubai_test:test123@db:5432/githubai_test
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    env_file:
      - ../../.env.test
    volumes:
      - ../../apps:/app/apps:rw
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  frontend:
    container_name: githubai_frontend_test
    ports:
      - "5174:5173"  # Different port to avoid conflicts
    environment:
      - VITE_API_URL=http://localhost:8001

  nginx:
    container_name: githubai_nginx_test
    ports:
      - "8081:80"  # Different port to avoid conflicts
    volumes:
      - static_test_volume:/app/staticfiles:ro
      - media_test_volume:/app/media:ro
    depends_on:
      - web

  docs:
    container_name: githubai_docs_test
    ports:
      - "8002:8001"  # Different port to avoid conflicts

volumes:
  postgres_test_data:
    name: githubai_postgres_test_data
  redis_test_data:
    name: githubai_redis_test_data
  static_test_volume:
    name: githubai_static_test_volume
  media_test_volume:
    name: githubai_media_test_volume
